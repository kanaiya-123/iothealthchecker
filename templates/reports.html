<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Core | Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Cyber Theme */
            --bg-dark: #0b0c15;
            --bg-panel: #151621;
            --accent-primary: #7c3aed; /* Purple */
            --accent-cyan: #06b6d4;   /* Cyan */
            --accent-success: #10b981;
            --text-main: #e2e8f0;
            --text-muted: #64748b;
            --border-light: rgba(255, 255, 255, 0.08);
            --font-tech: 'JetBrains Mono', monospace;
            --font-ui: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-light);
            padding: 25px;
            display: flex; flex-direction: column;
        }
        .logo { color: var(--accent-cyan); font-family: var(--font-tech); font-weight: 700; margin-bottom: 40px; }
        .nav-item { padding: 12px; color: var(--text-muted); display: block; margin-bottom: 5px; text-decoration: none; border-radius: 8px;}
        .nav-item:hover, .nav-item.active { background: rgba(6, 182, 212, 0.1); color: var(--accent-cyan); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; display: flex; flex-direction: column; overflow-y: auto;
        }

        /* Toolbar */
        .toolbar {
            padding: 20px 30px;
            background: rgba(11, 12, 21, 0.95);
            border-bottom: 1px solid var(--border-light);
            display: flex; justify-content: space-between; align-items: center;
        }

        .metric-badge {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 6px; border: 1px solid var(--border-light);
        }
        .metric-val { font-family: var(--font-tech); color: var(--accent-cyan); font-weight: 700; }

        /* GRID LAYOUT */
        .analytics-grid {
            padding: 30px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 25px;
        }

        /* PANEL STYLES */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }
        .panel-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* --- 1. VISUALIZATION PANEL (Holographic Graph) --- */
        .graph-container {
            height: 250px;
            display: flex; align-items: flex-end; justify-content: space-between; gap: 4px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
            position: relative;
        }
        
        /* Grid Lines */
        .graph-grid {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 50px; pointer-events: none;
        }

        .bar {
            flex: 1; background: linear-gradient(to top, rgba(6, 182, 212, 0.1), rgba(6, 182, 212, 0.8));
            border-top: 2px solid var(--accent-cyan);
            border-radius: 2px 2px 0 0;
            transition: height 0.5s ease;
            position: relative;
        }
        .bar:hover { filter: brightness(1.2); }
        .bar::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: inherit; filter: blur(10px); opacity: 0.5;
        }

        /* --- 2. REPORT GENERATOR (Query Builder) --- */
        .query-builder {
            display: flex; flex-direction: column; gap: 15px;
        }

        .query-row {
            display: flex; gap: 10px; align-items: center;
            background: #0f172a; padding: 10px; border-radius: 8px; border: 1px solid var(--border-light);
        }
        
        .q-label { font-family: var(--font-tech); color: var(--accent-primary); font-size: 0.8rem; text-transform: uppercase; }
        
        .q-select {
            background: transparent; border: none; color: white; outline: none; font-family: var(--font-ui); cursor: pointer; flex: 1;
        }
        .q-select option { background: var(--bg-panel); }

        .btn-gen {
            width: 100%; padding: 12px; background: var(--accent-primary); color: white; border: none;
            border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; gap: 10px;
            transition: 0.2s; margin-top: 10px;
        }
        .btn-gen:hover { background: #6d28d9; box-shadow: 0 0 15px rgba(124, 58, 237, 0.4); }

        /* --- 3. ARCHIVE TABLE --- */
        .archive-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .archive-table th { text-align: left; color: var(--text-muted); padding: 10px; font-size: 0.85rem; border-bottom: 1px solid var(--border-light); }
        .archive-table td { padding: 15px 10px; font-size: 0.9rem; border-bottom: 1px solid var(--border-light); }
        
        .status-tag { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; font-family: var(--font-tech); }
        .tag-sec { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .tag-sys { background: rgba(6, 182, 212, 0.1); color: #06b6d4; border: 1px solid rgba(6, 182, 212, 0.2); }

        .btn-dl { background: transparent; border: 1px solid var(--border-light); color: var(--text-muted); padding: 6px; border-radius: 4px; cursor: pointer; }
        .btn-dl:hover { color: white; border-color: white; }

        /* --- 4. LIVE LOG STREAM --- */
        .log-stream {
            height: 200px; overflow-y: hidden; position: relative;
            font-family: var(--font-tech); font-size: 0.8rem; color: #94a3b8;
        }
        /* Gradient mask to fade out top items */
        .log-stream::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height: 50px;
            background: linear-gradient(to bottom, var(--bg-panel), transparent); pointer-events: none;
        }
        
        .log-item { padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.05); display: flex; gap: 10px; animation: slideUp 0.3s ease-out; }
        .log-ts { color: var(--accent-primary); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-chart-pie"></i> ANALYTICS_CORE</div>
        <a href="{{ url_for('admin_dashboard') }}" class="nav-item">Dashboard</a>
        <a href="{{ url_for('manage_devices') }}" class="nav-item">System Monitor</a>
        <a href="{{ url_for('reports') }}" class="nav-item active"><i class="fa-solid fa-file-waveform"></i> Analyze & Report</a>
        <a href="#" class="nav-item">Logs</a>
        <a href="{{ url_for('logout') }}" class="nav-item">Logout</a>
    </div>

    <div class="main-content">
        
        <div class="toolbar">
            <h2 style="font-size: 1.2rem;">System Analysis & Reporting</h2>
            <div style="display: flex; gap: 15px;">
                <div class="metric-badge">
                    <i class="fa-solid fa-database" style="color: var(--text-muted)"></i>
                    <span>Storage:</span> <span class="metric-val">12GB / 50GB</span>
                </div>
                <div class="metric-badge">
                    <i class="fa-solid fa-server" style="color: var(--text-muted)"></i>
                    <span>Uptime:</span> <span class="metric-val">99.9%</span>
                </div>
            </div>
        </div>

        <div class="analytics-grid">
            
            <div class="panel" style="grid-column: span 1;">
                <div class="panel-header">
                    <div>Global Traffic Analysis <span style="font-size:0.8rem; color:var(--text-muted); font-weight:400">(Last 24h)</span></div>
                    <select style="background:var(--bg-dark); color:white; border:none; padding:5px; border-radius:4px;">
                        <option>Traffic Volume</option>
                        <option>Error Rate</option>
                        <option>API Latency</option>
                    </select>
                </div>
                <div class="graph-container" id="holoGraph">
                    <div class="graph-grid"></div>
                    </div>
            </div>

            <div class="panel" style="grid-column: span 1;">
                <div class="panel-header">Custom Report Builder</div>
                <form action="{{ url_for('export_health_data_pdf') }}" method="GET" id="reportForm">
                <div class="query-builder">
                    <div class="query-row">
                        <span class="q-label">SELECT</span>
                        <select class="q-select" name="data_type">
                            <option value="access_logs">System Access Logs</option>
                            <option value="vitals">Patient Vitals Summary</option>
                            <option value="activity">Doctor Activity</option>
                        </select>
                    </div>
                    <div class="query-row">
                        <span class="q-label">WHERE</span>
                        <select class="q-select" name="filter">
                            <option value="critical">Severity = Critical</option>
                            <option value="admin">Role = Admin</option>
                            <option value="30days">Date = Last 30 Days</option>
                        </select>
                    </div>
                    <div class="query-row">
                        <span class="q-label">FORMAT</span>
                        <select class="q-select" id="formatSelect">
                            <option value="pdf">PDF Document</option>
                            <option value="csv">CSV / Excel</option>
                        </select>
                    </div>

                    <button type="button" class="btn-gen" onclick="generateReport()">
                        <i class="fa-solid fa-microchip"></i> Compile & Download
                    </button>
                </div>
                </form>
            </div>

            <div class="panel">
                <div class="panel-header">Generated Archives</div>
                <table class="archive-table">
                    <thead>
                        <tr>
                            <th>Report ID</th>
                            <th>Type</th>
                            <th>Date Generated</th>
                            <th>Size</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="archiveBody">
                        <tr>
                            <td style="font-family: var(--font-tech)">RPT-2201</td>
                            <td><span class="status-tag tag-sec">Security Audit</span></td>
                            <td>Dec 20, 14:00</td>
                            <td>2.4 MB</td>
                            <td><button class="btn-dl"><i class="fa-solid fa-download"></i></button></td>
                        </tr>
                        <tr>
                            <td style="font-family: var(--font-tech)">RPT-2198</td>
                            <td><span class="status-tag tag-sys">Sys Performance</span></td>
                            <td>Dec 19, 09:30</td>
                            <td>1.1 MB</td>
                            <td><button class="btn-dl"><i class="fa-solid fa-download"></i></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="panel">
                <div class="panel-header">Live Ingestion Stream</div>
                <div class="log-stream" id="logStream">
                    </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. RENDER HOLOGRAPHIC BARS ---
        const graph = document.getElementById('holoGraph');
        function initGraph() {
            for(let i=0; i<30; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                // Random height
                const h = Math.floor(Math.random() * 80 + 10);
                bar.style.height = h + '%';
                graph.appendChild(bar);
            }
        }
        initGraph();

        // Animate Bars
        setInterval(() => {
            const bars = document.querySelectorAll('.bar');
            bars.forEach(bar => {
                const h = Math.floor(Math.random() * 80 + 10);
                bar.style.height = h + '%';
            });
        }, 1500);

        // --- 2. LIVE LOG SIMULATION ---
        const logs = [
            "POST /api/vitals 200 OK",
            "Auth: Admin_01 login success",
            "CRON: Backup job started",
            "WARN: High latency on Node-4",
            "GET /reports/download/2201",
            "DB: Connection pool refreshed"
        ];
        const logStream = document.getElementById('logStream');

        function addLog() {
            const text = logs[Math.floor(Math.random() * logs.length)];
            const time = new Date().toLocaleTimeString('en-GB');
            
            const div = document.createElement('div');
            div.className = 'log-item';
            div.innerHTML = `<span class="log-ts">[${time}]</span> ${text}`;
            
            logStream.prepend(div);
            
            // Limit items
            if(logStream.children.length > 8) {
                logStream.removeChild(logStream.lastChild);
            }
        }
        setInterval(addLog, 1200);

        // --- 3. REPORT GENERATION ---
        function generateReport() {
            const btn = document.querySelector('.btn-gen');
            const original = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing Data...';
            btn.style.opacity = '0.7';

            setTimeout(() => {
                btn.innerHTML = original;
                btn.style.opacity = '1';
                
                // Add new row to table
                const tbody = document.getElementById('archiveBody');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-family: var(--font-tech)">RPT-${Math.floor(Math.random()*1000 + 2000)}</td>
                    <td><span class="status-tag tag-sec">Custom Query</span></td>
                    <td>Just Now</td>
                    <td>0.5 MB</td>
                    <td><button class="btn-dl"><i class="fa-solid fa-download"></i></button></td>
                `;
                tbody.prepend(row);
                
                // Trigger real download
                const format = document.getElementById('formatSelect').value;
                if (format === 'pdf') {
                    window.location.href = "{{ url_for('export_health_data_pdf') }}";
                } else {
                    window.location.href = "{{ url_for('export_health_data_csv') }}";
                }
                
            }, 2000);
        }

    </script>
</body>
</html>