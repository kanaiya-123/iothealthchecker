<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Patients | Doctor Portal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --primary: #3b82f6;
            --accent-alert: #ef4444;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.08);
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 20px;
        }

        .brand { font-size: 1.2rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 5px; }
        .nav-item a { text-decoration: none; color: var(--text-muted); padding: 12px 15px; border-radius: 8px; display: flex; align-items: center; gap: 12px; font-size: 0.9rem; font-weight: 500; transition: 0.2s; }
        .nav-item a:hover, .nav-item a.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 30px;
        }

        /* Toolbar */
        .toolbar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
            background: var(--bg-panel); padding: 15px 25px; border-radius: 12px; border: 1px solid var(--border);
        }

        .search-wrapper {
            display: flex; align-items: center; gap: 10px; background: #0f172a; padding: 10px 15px;
            border-radius: 8px; border: 1px solid var(--border); width: 350px; color: var(--text-muted);
        }
        .search-wrapper input { background: transparent; border: none; outline: none; color: white; width: 100%; font-family: var(--font-ui); }

        .filter-tabs { display: flex; gap: 10px; }
        .tab-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: 0.2s;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab-btn:hover { border-color: var(--primary); color: var(--primary); }
        .tab-btn.active:hover { color: white; }

        /* PATIENT GRID */
        .patient-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px;
        }

        /* PATIENT CARD */
        .p-card {
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: 16px;
            padding: 20px; transition: transform 0.2s, border-color 0.2s; position: relative;
        }
        .p-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); }

        .p-header { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        
        .p-avatar {
            width: 50px; height: 50px; border-radius: 50%; background: #334155;
            display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 1.1rem;
            position: relative;
        }
        
        /* Status Dot on Avatar */
        .status-dot {
            position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; border-radius: 50%;
            border: 2px solid var(--bg-panel);
        }
        .st-stable { background: var(--accent-success); }
        .st-critical { background: var(--accent-alert); box-shadow: 0 0 10px var(--accent-alert); animation: pulse 1.5s infinite; }
        .st-warning { background: var(--accent-warning); }

        .p-info h3 { font-size: 1.1rem; margin-bottom: 3px; }
        .p-info p { font-size: 0.85rem; color: var(--text-muted); }

        /* Vitals Mini-Row */
        .vitals-row {
            display: flex; justify-content: space-between; background: rgba(0,0,0,0.2);
            padding: 12px; border-radius: 8px; margin-bottom: 20px;
        }
        .v-item { text-align: center; flex: 1; border-right: 1px solid rgba(255,255,255,0.05); }
        .v-item:last-child { border-right: none; }
        .v-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .v-val { font-family: var(--font-mono); font-weight: 600; color: var(--text-main); }
        
        .val-crit { color: var(--accent-alert); }

        /* Footer Actions */
        .p-actions { display: flex; gap: 10px; }
        .btn-view {
            flex: 1; padding: 10px; background: transparent; border: 1px solid var(--primary); color: var(--primary);
            border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; text-decoration: none; text-align: center;
        }
        .btn-view:hover { background: var(--primary); color: white; }
        
        .btn-icon {
            width: 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-muted);
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: white; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand"><i class="fa-solid fa-user-doctor"></i> DocPortal</div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="{{ url_for('doctor_dashboard') }}"><i class="fa-solid fa-table-columns"></i> Dashboard</a></li>
            <li class="nav-item"><a href="{{ url_for('my_patients') }}" class="active"><i class="fa-solid fa-hospital-user"></i> My Patients</a></li>
            <li class="nav-item"><a href="{{ url_for('assign_patients_page') }}"><i class="fa-solid fa-user-plus"></i> Assign Patients</a></li>
            <li class="nav-item"><a href="{{ url_for('doctor_ai_suggestions') }}"><i class="fa-solid fa-brain"></i> AI Suggestions</a></li>
            <li class="nav-item"><a href="{{ url_for('doctor_reports') }}"><i class="fa-solid fa-file-medical"></i> Reports</a></li>
            <li class="nav-item" style="margin-top: 20px;"><a href="{{ url_for('logout') }}"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</a></li>
        </ul>
    </nav>

    <main class="main-content">
        
        <h2 style="margin-bottom: 20px; font-weight: 600;">Assigned Patients Directory</h2>

        <div class="toolbar">
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Search by name, ID..." onkeyup="filterPatients()">
            </div>

            <div class="filter-tabs">
                <button class="tab-btn active" onclick="filterStatus('all')">All</button>
                <button class="tab-btn" onclick="filterStatus('Critical')">Critical</button>
                <button class="tab-btn" onclick="filterStatus('Stable')">Stable</button>
            </div>
        </div>

        <div class="patient-grid" id="patientGrid">
            <!-- Patients will be rendered here -->
        </div>

    </main>

    <script>
        // --- 1. PATIENT DATA FROM BACKEND ---
        const patients = [
            {% for p in patients_list %}
            { 
                id: "{{ p[0] }}", 
                name: "{{ p[1] }}", 
                age: {{ p[2] if p[2] else 0 }}, 
                gender: "{{ p[3] if p[3] else 'N/A' }}", 
                room: "{{ p[4] if p[4] else 'No Device' }}", 
                condition: "{{ 'Monitoring' if p[6] else 'No Data' }}", 
                vitals: { 
                    hr: {{ p[6] if p[6] else 0 }}, 
                    spo2: {{ p[7] if p[7] else 0 }}, 
                    temp: {{ p[8] if p[8] else 0 }} 
                }, 
                status: "{% if p[6] and (p[6] > 100 or p[6] < 50 or p[7] < 90) %}Critical{% elif p[6] %}Stable{% else %}Warning{% endif %}", 
                lastUpdate: "{{ p[9].strftime('%H:%M') if p[9] else 'Never' }}" 
            },
            {% endfor %}
        ];

        const grid = document.getElementById('patientGrid');

        // --- 2. RENDER FUNCTION ---
        function renderPatients(data) {
            grid.innerHTML = "";
            data.forEach(p => {
                // Determine Visual Styles
                let statusClass = "st-stable";
                if(p.status === "Critical") { statusClass = "st-critical"; }
                if(p.status === "Warning") { statusClass = "st-warning"; }

                // Vitals Coloring
                let hrStyle = (p.vitals.hr > 100 || (p.vitals.hr < 50 && p.vitals.hr > 0)) ? "val-crit" : "";
                let spo2Style = (p.vitals.spo2 < 90 && p.vitals.spo2 > 0) ? "val-crit" : "";

                const card = `
                    <div class="p-card">
                        <div class="p-header">
                            <div class="p-avatar">
                                ${p.name.charAt(0)}
                                <div class="status-dot ${statusClass}"></div>
                            </div>
                            <div class="p-info">
                                <h3>${p.name} <span style="font-size:0.8rem; color:var(--text-muted); font-weight:400">(${p.gender}, ${p.age})</span></h3>
                                <p><i class="fa-solid fa-microchip"></i> ${p.room} • ID: ${p.id}</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <span style="background:rgba(255,255,255,0.05); padding:4px 8px; border-radius:4px; font-size:0.8rem; color:var(--text-muted);">
                                ${p.condition}
                            </span>
                        </div>

                        <div class="vitals-row">
                            <div class="v-item">
                                <div class="v-label">Heart Rate</div>
                                <div class="v-val ${hrStyle}">${p.vitals.hr || '--'} <small>bpm</small></div>
                            </div>
                            <div class="v-item">
                                <div class="v-label">SpO2</div>
                                <div class="v-val ${spo2Style}">${p.vitals.spo2 || '--'}%</div>
                            </div>
                            <div class="v-item">
                                <div class="v-label">Temp</div>
                                <div class="v-val">${p.vitals.temp || '--'}°C</div>
                            </div>
                        </div>

                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:15px; text-align:right;">
                            <i class="fa-regular fa-clock"></i> Updated: ${p.lastUpdate}
                        </div>

                        <div class="p-actions">
                            <a href="/doctor/health_data/${p.id}" class="btn-view">View Health Data</a>
                            <button class="btn-icon" title="Message"><i class="fa-regular fa-envelope"></i></button>
                            <button class="btn-icon" title="History"><i class="fa-solid fa-clock-rotate-left"></i></button>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        // --- 3. FILTER LOGIC ---
        function filterPatients() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = patients.filter(p => 
                p.name.toLowerCase().includes(query) || 
                p.id.toLowerCase().includes(query)
            );
            renderPatients(filtered);
        }

        function filterStatus(status) {
            // UI Toggle
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if(status === 'all') {
                renderPatients(patients);
            } else {
                const filtered = patients.filter(p => p.status === status);
                renderPatients(filtered);
            }
        }

        // Initial Load
        renderPatients(patients);

    </script>
</body>
</html>